<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="https://github.com/letu-rebel/hi-pat/blob/main/extras/patty-plinko.ico?raw=true" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patty Plinko</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.17.1/matter.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://marvel-b1-cdn.bc0a.com/f00000000047992/www.letu.edu/alumni/images/academic-social/academic-social-alum-3.jpg') no-repeat center center fixed;
            background-size: cover;
            filter: blur(7px) brightness(0.65);
            z-index: -1;
        }

        canvas {
            display: block;
        }
    </style>
</head>
    
<body>
    <div id="background"></div>
    <script>
        const Engine = Matter.Engine,
            Render = Matter.Render,
            World = Matter.World,
            Bodies = Matter.Bodies;

        const screen_width = window.innerWidth;
        const screen_height = window.innerHeight;
        const peg_spacing = 60;
        const peg_radius = 10;
        const ball_density = 0.0002;
        const ball_count = Math.floor(screen_width * screen_height * ball_density);

        // Create engine and set gravity
        const engine = Engine.create();
        engine.world.gravity.y = .4; // Adjust this value for vertical gravity
        engine.world.gravity.x = 0; // Adjust this value for horizontal gravity

        const render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: screen_width,
                height: screen_height,
                wireframes: false,
                background: 'transparent'
            }
        });

        Engine.run(engine);
        Render.run(render);

        function createPegs() {
            let rows = (screen_height - 50) / peg_spacing;
            let cols = screen_width / peg_spacing;
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    let offset = (peg_radius + peg_spacing / 2) * (row % 2);
                    let x = col * peg_spacing + peg_radius + offset;
                    let y = row * peg_spacing + peg_radius + 50;
                    let peg = Bodies.circle(x, y, peg_radius, {
                        isStatic: true,
                        render: { fillStyle: '#333' } // Dark grey color
                    });
                    World.add(engine.world, peg);
                }
            }
        }

        // Spawn a ball with custom restitution and friction
        function spawnBall() {
            let radius = 16;
            let x, y;
            x = Math.random() * (screen_width - radius * 2) + radius;
            y = -radius;
            let imageURL = "https://github.com/letu-rebel/hi-pat/blob/main/maysmoments/lil_mays.png?raw=true";

            return Bodies.circle(x, y, radius, {
                restitution: 0.9,
                friction: .005,
                render: {
                    sprite: {
                        texture: imageURL,
                        xScale: .5,
                        yScale: .5
                    }
                }
            });
        }


        createPegs();

        let balls = [];
        for (let i = 0; i < ball_count; i++) {
            balls[i] = spawnBall();
            World.add(engine.world, balls[i]);
        }

        if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
            // iOS 13+
            document.body.addEventListener('click', function() {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleDeviceOrientation);
                        }
                    })
                    .catch(console.error);
            });
        } else {
            // Non-iOS 13+
            window.addEventListener('deviceorientation', handleDeviceOrientation);
        }

        // Device orientation event listener
        function handleDeviceOrientation(event) {
            let beta = event.beta;  // front-to-back tilt (rotation around x-axis)
            let gamma = event.gamma; // left-to-right tilt (rotation around y-axis)

            // Check if the orientation values are valid
            if (beta !== null && gamma !== null) {
                // Convert the orientation into gravity components
                let gravityX = Math.sin(gamma * (Math.PI / 180));
                let gravityY = Math.sin(beta * (Math.PI / 180));
                
                // Set the gravity in your physics engine
                engine.world.gravity.x = gravityX;
                engine.world.gravity.y = gravityY;
            }
        }

        Matter.Events.on(engine, 'afterUpdate', function() {
            balls.forEach((ball, index) => {
                if (ball.position.y > screen_height + ball.circleRadius) {
                    World.remove(engine.world, ball);
                    balls[index] = spawnBall();
                    World.add(engine.world, balls[index]);
                }

                // Check if the ball goes off the left side
                if (ball.position.x < -ball.circleRadius) {
                    Matter.Body.setPosition(ball, { x: screen_width + ball.circleRadius, y: ball.position.y });
                }

                // Check if the ball goes off the right side
                if (ball.position.x > screen_width + ball.circleRadius) {
                    Matter.Body.setPosition(ball, { x: -ball.circleRadius, y: ball.position.y });
                }
            });
        });

        // Event listener for window resize
        window.addEventListener('resize', function() {
            location.reload(); // Reloads the page
        });
    </script>
</body>
</html>